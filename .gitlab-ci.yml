# -----------------------------------------------------------------------------
# GitLab CI/CD Configuration for ArtisanPack UI
#
# This pipeline installs dependencies, runs tests, and on tag push,
# automatically publishes to npm and creates a GitLab Release with notes
# extracted from CHANGELOG.md.
#
# @package    ArtisanPack UI
# @since      1.0.0
# @version    1.2.0
# -----------------------------------------------------------------------------

image: node:lts

stages:
  - install
  - test
  - deploy

cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/

install_dependencies:
  stage: install
  script:
    - echo "Installing project dependencies..."
    - npm ci

# This job runs the Jest test suite.
run_jest_tests:
  stage: test
  # This setting allows the job to fail without stopping the pipeline.
  # The pipeline will proceed to the deploy stage even if tests do not pass.
  allow_failure: true
  script:
    - echo "Running Jest test suite..."
    - npm run test

# This job runs first in the 'deploy' stage on a tag push.
# It parses the CHANGELOG.md file to find the notes for the current version
# and passes them to the next job.
prepare_release_notes:
  stage: deploy
  image: alpine:latest
  script:
    - |
      echo "--- Preparing Release Notes from CHANGELOG.md ---"
      RELEASE_VERSION=$(echo "${CI_COMMIT_TAG}" | sed 's/^v//')
      echo "Parsing changelog for version: ${RELEASE_VERSION}"
      RELEASE_NOTES=$(sed -n "/^## \[${RELEASE_VERSION}\]/,/^## \[/p" CHANGELOG.md | sed '1d;$d' | sed -e 's/^[[:space:]]*//' -e '/^$/d')
      if [ -z "${RELEASE_NOTES}" ]; then
        echo "Warning: Could not find release notes for version ${RELEASE_VERSION}. Using a generic description."
        RELEASE_NOTES="Release ${CI_COMMIT_TAG}. Please see CHANGELOG.md for details."
      fi
      echo "--- Final Release Notes ---"
      echo "${RELEASE_NOTES}"
      echo "---------------------------"
      echo "RELEASE_DESCRIPTION=${RELEASE_NOTES}" > release.env
  rules:
    - if: $CI_COMMIT_TAG
  artifacts:
    reports:
      dotenv: release.env

# This job publishes to npm and creates the GitLab Release.
# It depends on the notes prepared in the previous job.
publish_to_npm_and_release:
  stage: deploy
  needs:
    - job: prepare_release_notes
      artifacts: true
  script:
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
    - npm publish
    - echo "Creating GitLab Release for tag ${CI_COMMIT_TAG}..."
    - release-cli create --name "Release ${CI_COMMIT_TAG}" --tag-name "${CI_COMMIT_TAG}" --description "${RELEASE_DESCRIPTION}"
  rules:
    - if: $CI_COMMIT_TAG