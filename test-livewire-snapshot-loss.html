<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Livewire wire:snapshot Loss</title>
    <style>
        .drag-item {
            padding: 15px;
            margin: 8px 0;
            background: #f0f0f0;
            border: 2px solid #ccc;
            cursor: grab;
            border-radius: 4px;
            font-weight: bold;
            position: relative;
        }
        .drag-item:active {
            cursor: grabbing;
        }
        .is-dragging {
            opacity: 0.5;
            background: #e0e0e0;
            border-color: #007acc;
        }
        .sr-only {
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .log {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-left: 4px solid #007acc;
            background: white;
            font-family: monospace;
            font-size: 12px;
        }
        .error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .warning {
            border-left-color: #ff9800;
            background: #fff3e0;
        }
        .info {
            border-left-color: #2196f3;
            background: #e3f2fd;
        }
        .instructions {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .attributes-display {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Livewire wire:snapshot Loss Issue</h1>
        
        <div class="instructions">
            <h3>Test Setup:</h3>
            <p>This test simulates a Livewire component with wire:snapshot and wire:id attributes to reproduce the issue where wire:snapshot is lost during drag operations.</p>
            <p><strong>Expected Issue:</strong> After dragging, the parent container should lose its wire:snapshot attribute but retain wire:id.</p>
        </div>
        
        <!-- Simulate Livewire component with wire:snapshot and wire:id -->
        <div id="livewire-component" 
             wire:id="component-123" 
             wire:snapshot='{"data":{"items":[{"id":1,"name":"Item 1"},{"id":2,"name":"Item 2"},{"id":3,"name":"Item 3"}]},"memo":{"id":"component-123","name":"dashboard","path":"admin/dashboard","method":"GET","children":[],"scripts":[],"assets":[],"errors":[],"locale":"en"},"checksum":"abc123"}'
             x-data="{
                 logAttributeChange: () => {
                     const component = document.getElementById('livewire-component');
                     const hasSnapshot = component.hasAttribute('wire:snapshot');
                     const hasId = component.hasAttribute('wire:id');
                     const snapshotValue = component.getAttribute('wire:snapshot');
                     const idValue = component.getAttribute('wire:id');
                     
                     logResult('AFTER DRAG', hasSnapshot, hasId, snapshotValue, idValue);
                 }
             }" 
             x-drag-context 
             @drag:end="logAttributeChange()" 
             role="application" 
             aria-label="Livewire drag and drop test">
            
            <div class="drag-item" x-drag-item="{id: 1, name: 'Item 1'}" tabindex="0">
                <strong>Item 1</strong> - Drag me to test wire:snapshot loss
            </div>
            <div class="drag-item" x-drag-item="{id: 2, name: 'Item 2'}" tabindex="0">
                <strong>Item 2</strong> - Drag me to test wire:snapshot loss
            </div>
            <div class="drag-item" x-drag-item="{id: 3, name: 'Item 3'}" tabindex="0">
                <strong>Item 3</strong> - Drag me to test wire:snapshot loss
            </div>
        </div>

        <div class="attributes-display">
            <h4>Live Attributes Monitor:</h4>
            <div id="attributes-monitor"></div>
        </div>

        <div class="log">
            <h3>Wire Attributes Test Log:</h3>
            <button onclick="clearLog()" style="margin-bottom: 10px; padding: 5px 10px;">Clear Log</button>
            <button onclick="checkAttributes()" style="margin-bottom: 10px; padding: 5px 10px;">Check Attributes Now</button>
            <div id="log-entries"></div>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
            <h3>What to Look For:</h3>
            <ul>
                <li><strong>Before drag:</strong> Component should have both wire:id and wire:snapshot attributes</li>
                <li><strong>After drag:</strong> Component should lose wire:snapshot but keep wire:id</li>
                <li><strong>Root cause:</strong> DOM manipulation via insertBefore() doesn't notify Livewire</li>
                <li><strong>Impact:</strong> May cause Livewire component hydration issues</li>
            </ul>
        </div>
    </div>

    <script type="module">
        // Function to log wire attribute results
        window.logResult = function(phase, hasSnapshot, hasId, snapshotValue, idValue) {
            const logEntries = document.getElementById('log-entries');
            const entry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            
            // Determine if there's an issue
            const isIssue = !hasSnapshot && hasId; // Lost snapshot but kept ID
            
            entry.className = `log-entry ${isIssue ? 'error' : 'info'}`;
            entry.innerHTML = `
                <div><strong>[${timestamp}] ${phase}:</strong></div>
                <div><strong>wire:id:</strong> ${hasId ? '‚úÖ Present' : '‚ùå Missing'} ${idValue ? `(${idValue})` : ''}</div>
                <div><strong>wire:snapshot:</strong> ${hasSnapshot ? '‚úÖ Present' : '‚ùå Missing'}</div>
                ${isIssue ? 
                    `<div style="color: #d32f2f;">üö® ISSUE DETECTED: wire:snapshot lost but wire:id retained</div>` :
                    hasSnapshot ? 
                        `<div style="color: #2e7d32;">‚úÖ Both attributes present</div>` :
                        `<div style="color: #666;">‚ÑπÔ∏è Both attributes missing (expected after DOM manipulation)</div>`
                }
                ${snapshotValue && snapshotValue.length > 50 ? 
                    `<details><summary>View wire:snapshot content</summary><pre>${snapshotValue}</pre></details>` : 
                    ''
                }
            `;
            
            logEntries.insertBefore(entry, logEntries.firstChild);
        };

        // Function to check attributes manually
        window.checkAttributes = function() {
            const component = document.getElementById('livewire-component');
            const hasSnapshot = component.hasAttribute('wire:snapshot');
            const hasId = component.hasAttribute('wire:id');
            const snapshotValue = component.getAttribute('wire:snapshot');
            const idValue = component.getAttribute('wire:id');
            
            logResult('MANUAL CHECK', hasSnapshot, hasId, snapshotValue, idValue);
            updateAttributesMonitor();
        };

        // Function to update live attributes monitor
        function updateAttributesMonitor() {
            const component = document.getElementById('livewire-component');
            const monitor = document.getElementById('attributes-monitor');
            const hasSnapshot = component.hasAttribute('wire:snapshot');
            const hasId = component.hasAttribute('wire:id');
            const idValue = component.getAttribute('wire:id');
            
            monitor.innerHTML = `
                <div><strong>wire:id:</strong> <span style="color: ${hasId ? 'green' : 'red'}">${hasId ? '‚úÖ ' + idValue : '‚ùå Missing'}</span></div>
                <div><strong>wire:snapshot:</strong> <span style="color: ${hasSnapshot ? 'green' : 'red'}">${hasSnapshot ? '‚úÖ Present' : '‚ùå Missing'}</span></div>
                <div><em>Last checked: ${new Date().toLocaleTimeString()}</em></div>
            `;
        }

        // Function to clear log
        window.clearLog = function() {
            document.getElementById('log-entries').innerHTML = '';
        };

        // Set up periodic monitoring
        setInterval(updateAttributesMonitor, 1000);

        import Alpine from './node_modules/alpinejs/dist/module.esm.js';
        import LivewireDragAndDrop from './src/index.js';

        try {
            LivewireDragAndDrop(Alpine);
            Alpine.start();
            console.log('‚úÖ Test environment initialized');
            
            // Log initial state
            setTimeout(() => {
                checkAttributes();
                
                const logEntries = document.getElementById('log-entries');
                const entry = document.createElement('div');
                entry.className = 'log-entry info';
                entry.innerHTML = `
                    <strong>üöÄ Test Environment Ready</strong><br>
                    Drag items to test wire:snapshot loss. Monitor the attributes display above.
                `;
                logEntries.appendChild(entry);
            }, 500);
            
        } catch (error) {
            console.error('‚ùå Error initializing test:', error);
            const logEntries = document.getElementById('log-entries');
            const entry = document.createElement('div');
            entry.className = 'log-entry error';
            entry.innerHTML = `<strong>‚ùå Initialization Error:</strong> ${error.message}`;
            logEntries.appendChild(entry);
        }
    </script>
</body>
</html>